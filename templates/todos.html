{% extends "layout.html" %}

{% block title %}Assignments - StudyVerse{% endblock %}

{% block content %}
<header class="top-bar"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div class="page-title">All Assignments</div>
    <div class="top-actions" style="display: flex; gap: 16px;">
        <div class="mode-switcher">
            <button class="mode-btn active" onclick="switchTab('personal')" id="btn-personal">Personal</button>
            <button class="mode-btn" onclick="switchTab('group')" id="btn-group">Group</button>
        </div>
        <div class="user-profile-mini">
            <img src="{{ current_user.get_avatar(64) }}" alt="User"
                style="width: 32px; height: 32px; border-radius: 50%;">
        </div>
    </div>
</header>

<div class="dashboard-grid" style="grid-template-columns: 1fr;">
    <div class="widget" style="min-height: 80vh; background: transparent; border: none; padding: 0;">
        <div class="widget-header"
            style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div class="widget-title" style="font-size: 1.2rem; font-weight: 600; color: var(--accent-green);">Project
                Tasks</div>
            <div style="display: flex; gap: 10px;">
                <input type="text" placeholder="Search tasks..."
                    style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); color: white; padding: 8px 12px; border-radius: 6px; outline: none; min-width: 250px;">
                <button class="btn-primary" onclick="openAddTaskModal()"
                    style="background: var(--accent-green); color: black; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">+
                    New Task</button>
            </div>
        </div>

        <div class="task-list-container">
            <!-- Header -->
            <div class="task-tree-header">
                <div></div> <!-- Checkbox/Expand -->
                <div style="padding-left: 10px;">Task Name</div>
                <div>Category</div>
                <div>Priority</div>
                <div>Status</div>
                <div>Due Date</div>
                <div>Action</div>
            </div>

            <!-- Personal Tasks Container -->
            <div id="personal-tasks-container">
                <!-- We manually group by iterating twice to avoid Jinja sort errors on None types -->

                <!-- 1. Tasks with Categories -->
                {% set categories = [] %}
                {% for t in personal_todos %}
                {% if t.category and t.category not in categories %}
                {% if categories.append(t.category) %}{% endif %}
                {% endif %}
                {% endfor %}

                {% for cat in categories %}
                {% set cat_todos = [] %}
                {% set cat_pending = false %}
                {% for t in personal_todos %}
                {% if t.category == cat %}
                {% if cat_todos.append(t) %}{% endif %}
                {% endif %}
                {% endfor %}

                {% set pending_list = [] %}
                {% for t in cat_todos %}
                {% if not t.completed %}{% if pending_list.append(1) %}{% endif %}{% endif %}
                {% endfor %}
                {% set cat_pending = pending_list|length > 0 %}

                <!-- Category Header -->
                <div class="task-row parent">
                    <div class="flex-center">
                        <button class="toggle-btn {% if cat_pending %}expanded{% endif %}" onclick="toggleGroup(this)">
                            <i class="fa-solid fa-chevron-right"
                                style="transform: rotate({% if cat_pending %}90deg{% else %}0deg{% endif %});"></i>
                        </button>
                    </div>
                    <div class="task-title" style="font-weight: 600; color: var(--accent-green);">
                        {% if 'python' in cat.lower() %}
                        <i class="fa-brands fa-python" style="margin-right: 8px; color: #3b82f6;"></i>
                        {% elif 'web' in cat.lower() or 'design' in cat.lower() %}
                        <i class="fa-solid fa-globe" style="margin-right: 8px; color: #a855f7;"></i>
                        {% else %}
                        <i class="fa-solid fa-layer-group" style="margin-right: 8px;"></i>
                        {% endif %}
                        {{ cat }}
                        <!-- cat_todos already defined above -->
                        <span
                            style="font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; margin-left: 10px; color: var(--text-secondary);">{{
                            cat_todos|length }}</span>
                    </div>
                    <div>-</div>
                    <div>-</div>
                    <div>-</div>
                    <div>
                        {% set completed = [] %}
                        {% for t in cat_todos %}{% if t.completed %}{% if completed.append(t) %}{% endif %}{% endif %}{%
                        endfor %}
                        {% set percent = (completed|length / cat_todos|length * 100)|int if cat_todos|length > 0 else 0
                        %}
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <div class="grid-progress" style="flex: 1;">
                                <div class="grid-progress-bar" style="width: {{ percent }}%;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-secondary); min-width: 30px;">{{ percent
                                }}%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center;">
                        <form method="POST" action="{{ url_for('todos_delete_category') }}"
                            onsubmit="return confirm('Are you sure you want to delete all tasks in {{ cat }}?');"
                            style="margin: 0;">
                            <input type="hidden" name="category" value="{{ cat }}">
                            <input type="hidden" name="is_group" value="0">
                            <button type="submit" class="btn-icon" title="Delete Category"
                                style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444; cursor: pointer; border-radius: 6px; padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Subtasks -->
                <div class="task-group" style="display: {% if cat_pending %}block{% else %}none{% endif %};">
                    {% for t in personal_todos %}
                    {% if t.category == cat %}
                    <div class="task-row subtask">
                        <div class="flex-center"></div> <!-- Indent -->
                        <div class="task-cell">
                            <form method="POST" action="{{ url_for('todos_toggle', todo_id=t.id) }}" style="margin:0;">
                                <input type="checkbox" class="task-checkbox {% if t.completed %}checked{% endif %}"
                                    onchange="this.form.submit()" {% if t.completed %}checked{% endif %}>
                            </form>
                            <div class="task-title"
                                style="margin-left: 12px; {% if t.completed %}text-decoration: line-through; opacity: 0.5;{% endif %}">
                                {{ t.title }}
                            </div>
                        </div>
                        <div class="task-cell" style="color: var(--text-muted); font-size: 0.85rem;">Self</div>
                        <div class="task-cell">
                            <span
                                class="badge {% if t.priority == 'High' %}badge-high{% elif t.priority == 'Medium' %}badge-med{% else %}badge-low{% endif %}">
                                {{ t.priority }}
                            </span>
                        </div>
                        <div class="task-cell">
                            {% if t.completed %}
                            <span class="badge badge-done">Done</span>
                            {% else %}
                            <span class="badge badge-todo">Todo</span>
                            {% endif %}
                        </div>
                        <div class="task-cell" style="color: var(--text-secondary); font-size: 0.85rem;">{{ t.due_date
                            or '-' }}</div>
                        <div class="task-cell">
                            <form method="POST" action="{{ url_for('todos_delete', todo_id=t.id) }}" style="margin:0;">
                                <button class="btn-icon" type="submit"
                                    style="background: transparent; border: 1px solid transparent; color: var(--text-secondary); cursor: pointer; transition: 0.2s; border-radius: 6px;">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}

                <!-- 2. Uncategorized Tasks -->
                {% set has_uncategorized = false %}
                {% set uncat_pending_list = [] %}
                {% for t in personal_todos %}
                {% if not t.category %}
                {% set has_uncategorized = true %}
                {% if not t.completed %}{% if uncat_pending_list.append(1) %}{% endif %}{% endif %}
                {% endif %}
                {% endfor %}
                {% set uncat_pending = uncat_pending_list|length > 0 %}

                {% if has_uncategorized %}
                <div class="task-row parent">
                    <div class="flex-center">
                        <button class="toggle-btn {% if uncat_pending %}expanded{% endif %}"
                            onclick="toggleGroup(this)">
                            <i class="fa-solid fa-chevron-right"
                                style="transform: rotate({% if uncat_pending %}90deg{% else %}0deg{% endif %});"></i>
                        </button>
                    </div>
                    <div class="task-title" style="font-weight: 600; color: var(--text-secondary);">
                        <i class="fa-solid fa-inbox" style="margin-right: 8px;"></i>
                        Inbox (Uncategorized)
                    </div>
                    <div>-</div>
                    <div>-</div>
                    <div>-</div>
                    <div>-</div>
                    <div></div>
                </div>
                <div class="task-group" style="display: {% if uncat_pending %}block{% else %}none{% endif %};">
                    {% for t in personal_todos %}
                    {% if not t.category %}
                    <div class="task-row subtask">
                        <div class="flex-center"></div>
                        <div class="task-cell">
                            <form method="POST" action="{{ url_for('todos_toggle', todo_id=t.id) }}" style="margin:0;">
                                <input type="checkbox" class="task-checkbox {% if t.completed %}checked{% endif %}"
                                    onchange="this.form.submit()" {% if t.completed %}checked{% endif %}>
                            </form>
                            <div class="task-title"
                                style="margin-left: 12px; {% if t.completed %}text-decoration: line-through; opacity: 0.5;{% endif %}">
                                {{ t.title }}
                            </div>
                        </div>
                        <div class="task-cell">-</div>
                        <div class="task-cell">
                            <span
                                class="badge {% if t.priority == 'High' %}badge-high{% elif t.priority == 'Medium' %}badge-med{% else %}badge-low{% endif %}">
                                {{ t.priority }}
                            </span>
                        </div>
                        <div class="task-cell">
                            {% if t.completed %}
                            <span class="badge badge-done">Done</span>
                            {% else %}
                            <span class="badge badge-todo">Pending</span>
                            {% endif %}
                        </div>
                        <div class="task-cell" style="color: var(--text-secondary); font-size: 0.85rem;">{{ t.due_date
                            or '-' }}</div>
                        <div class="task-cell">
                            <form method="POST" action="{{ url_for('todos_delete', todo_id=t.id) }}" style="margin:0;">
                                <button class="btn-ghost" type="submit"
                                    style="color: var(--destructive); padding: 4px;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if not personal_todos %}
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    No tasks yet. Create one to get started!
                </div>
                {% endif %}
            </div>

            <!-- Group Tasks Container -->
            <!-- Group Tasks Container -->
            <div id="group-tasks-container" style="display: none;">
                {% if group_todos and group_todos|length > 0 %}

                <!-- Use same grouping logic as Personal -->
                {% set g_categories = [] %}
                {% for t in group_todos %}
                {% set cat_name = t.category if t.category else 'General' %}
                {% if cat_name not in g_categories %}
                {% if g_categories.append(cat_name) %}{% endif %}
                {% endif %}
                {% endfor %}

                {% for cat in g_categories %}
                {% set g_cat_todos = [] %}
                {% set g_cat_pending_list = [] %}

                {% for t in group_todos %}
                {% set t_cat = t.category if t.category else 'General' %}
                {% if t_cat == cat %}
                {% if g_cat_todos.append(t) %}{% endif %}
                <!-- Check if *individually* pending for current user -->
                {% set is_individually_done = (current_user.id|string) in t.completed_by.split(',') %}
                {% if not is_individually_done %}
                {% if g_cat_pending_list.append(1) %}{% endif %}
                {% endif %}
                {% endif %}
                {% endfor %}

                {% set g_cat_pending = g_cat_pending_list|length > 0 %}

                <div class="task-row parent">
                    <div class="flex-center">
                        <button class="toggle-btn {% if g_cat_pending %}expanded{% endif %}"
                            onclick="toggleGroup(this)">
                            <i class="fa-solid fa-chevron-right"
                                style="transform: rotate({% if g_cat_pending %}90deg{% else %}0deg{% endif %});"></i>
                        </button>
                    </div>
                    <div class="task-title" style="color: var(--purple); font-weight: 600;">
                        <i class="fa-solid fa-users" style="margin-right: 8px;"></i>
                        {{ cat }}
                        <span
                            style="font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; margin-left: 10px; color: var(--text-secondary);">
                            {{ g_cat_todos|length }}
                        </span>
                    </div>
                    <div>-</div>
                    <div>-</div>
                    <div>-</div>
                    <div>-</div>
                    <div style="display: flex; justify-content: center;">
                        {% if current_group and current_group.admin_id == current_user.id %}
                        <form method="POST" action="{{ url_for('todos_delete_category') }}"
                            onsubmit="return confirm('Delete all group tasks in {{ cat }}?');" style="margin: 0;">
                            <input type="hidden" name="category" value="{{ cat }}">
                            <input type="hidden" name="is_group" value="1">
                            <button type="submit" class="btn-icon" title="Delete Category"
                                style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444; cursor: pointer; border-radius: 6px; padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <div class="task-group" style="display: {% if g_cat_pending %}block{% else %}none{% endif %};">
                    {% for t in g_cat_todos %}
                    {% set is_individually_done = (current_user.id|string) in t.completed_by.split(',') %}

                    <div class="task-row subtask">
                        <div class="flex-center"></div>
                        <div class="task-cell">
                            <form method="POST" action="{{ url_for('todos_toggle', todo_id=t.id) }}" style="margin:0;">
                                <input type="checkbox"
                                    class="task-checkbox {% if is_individually_done %}checked{% endif %}"
                                    onchange="this.form.submit()" {% if is_individually_done %}checked{% endif %}>
                            </form>
                            <div class="task-title"
                                style="margin-left: 12px; {% if is_individually_done %}text-decoration: line-through; opacity: 0.5;{% endif %}">
                                {{ t.title }}
                                {% if t.completed %}
                                <span class="badge"
                                    style="background: var(--accent-green); color: black; font-size: 0.7rem; margin-left: 8px;">All
                                    Done</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="task-cell">Group</div>
                        <div class="task-cell"><span class="badge badge-low">{{ t.priority }}</span></div>
                        <div class="task-cell">
                            {% if is_individually_done %}<span class="badge badge-done">Done</span>{% else %}<span
                                class="badge badge-todo">Pending</span>{% endif %}
                        </div>
                        <div class="task-cell" style="color: var(--text-secondary);">{{ t.due_date or '-' }}</div>
                        <div class="task-cell">
                            {% if current_group and current_group.admin_id == current_user.id %}
                            <form method="POST" action="{{ url_for('todos_delete', todo_id=t.id) }}" style="margin:0;">
                                <button class="btn-icon" type="submit"
                                    style="background: transparent; border: 1px solid transparent; color: var(--text-secondary); cursor: pointer; transition: 0.2s; border-radius: 6px;">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                {% else %}
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    {% if not current_group %}
                    You are not in a group. <a href="{{ url_for('group_chat') }}"
                        style="color: var(--accent-green);">Join or Create one</a> in Friends!
                    {% else %}
                    No group tasks yet. Add one to collaborate!
                    {% endif %}
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 style="font-size: 1.5rem;">New Task Group</h2>
            <span class="close-modal" onclick="closeAddTaskModal()">&times;</span>
        </div>
        <div id="addTaskForm">
            <!-- Task Title (becomes Category) -->
            <div class="form-group">
                <label>Task Title</label>
                <input type="text" id="taskTitle" placeholder="e.g. History Project" required>
            </div>

            <!-- Priority Buttons -->
            <div class="form-group">
                <label>Priority</label>
                <div class="priority-selector">
                    <button type="button" class="priority-btn" data-value="Low"
                        onclick="selectPriority('Low')">Low</button>
                    <button type="button" class="priority-btn active" data-value="Medium"
                        onclick="selectPriority('Medium')">Medium</button>
                    <button type="button" class="priority-btn" data-value="High"
                        onclick="selectPriority('High')">High</button>
                </div>
                <input type="hidden" id="taskPriority" value="Medium">
            </div>

            <!-- Deadline -->
            <div class="form-group">
                <label>Deadline</label>
                <input type="date" id="taskDueDate">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Subtasks Section -->
            <div class="form-group">
                <label>Subtasks</label>
                <div id="subtaskList"
                    style="margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; padding-right: 5px;">
                    <!-- Subtasks will appear here -->
                </div>
                <button type="button" class="btn-secondary" onclick="promptSubtask()"
                    style="width: 100%; border-style: dashed;">
                    + Add Sub Task
                </button>
            </div>

            <input type="hidden" id="modal-is-group" value="0">

            <div class="modal-btn-group" style="margin-top: 24px;">
                <button type="button" class="btn-secondary btn-cancel" onclick="closeAddTaskModal()"
                    style="font-weight: 500;">Cancel</button>
                <button type="button" id="btnDone" class="btn-primary" onclick="submitTask()" disabled
                    style="background: var(--accent-green); color: black; opacity: 0.5; cursor: not-allowed; font-weight: 700; padding: 10px 24px; box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2); transition: all 0.3s ease;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .priority-selector {
        display: flex;
        gap: 10px;
    }

    .priority-btn {
        flex: 1;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .priority-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--text-muted);
    }

    .priority-btn.active {
        background: var(--accent-green);
        color: black;
        border-color: var(--accent-green);
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2);
    }

    .subtask-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.02);
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid var(--border);
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .subtask-item span {
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .subtask-remove {
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        transition: color 0.2s;
    }

    .subtask-remove:hover {
        color: var(--destructive);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.querySelector('[data-nav="todos"]').classList.add('active');

    let currentSubtasks = [];

    function switchTab(tab) {
        document.getElementById('personal-tasks-container').style.display = tab === 'personal' ? 'block' : 'none';
        document.getElementById('group-tasks-container').style.display = tab === 'group' ? 'block' : 'none';

        document.getElementById('btn-personal').classList.toggle('active', tab === 'personal');
        document.getElementById('btn-group').classList.toggle('active', tab === 'group');

        document.getElementById('modal-is-group').value = tab === 'group' ? '1' : '0';
    }

    function toggleGroup(btn) {
        const row = btn.closest('.task-row');
        const group = row.nextElementSibling;
        if (group && group.classList.contains('task-group')) {
            if (group.style.display === 'none') {
                group.style.display = 'block';
                btn.classList.add('expanded');
                // Ensure icon rotates
                const icon = btn.querySelector('i');
                if (icon) icon.style.transform = 'rotate(90deg)';
            } else {
                group.style.display = 'none';
                btn.classList.remove('expanded');
                const icon = btn.querySelector('i');
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    function openAddTaskModal() {
        document.getElementById('addTaskModal').style.display = 'flex';
        // Reset form
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDueDate').value = '';
        selectPriority('Medium');
        currentSubtasks = [];
        updateSubtaskList();
    }

    function closeAddTaskModal() {
        document.getElementById('addTaskModal').style.display = 'none';
    }

    // Modal Interaction Logic
    function selectPriority(priority) {
        document.getElementById('taskPriority').value = priority;
        document.querySelectorAll('.priority-btn').forEach(btn => {
            if (btn.dataset.value === priority) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function promptSubtask() {
        const subtask = prompt("Enter subtask name:");
        if (subtask && subtask.trim() !== "") {
            currentSubtasks.push(subtask.trim());
            updateSubtaskList();
        }
    }

    function removeSubtask(index) {
        currentSubtasks.splice(index, 1);
        updateSubtaskList();
    }

    function updateSubtaskList() {
        const list = document.getElementById('subtaskList');
        list.innerHTML = '';

        currentSubtasks.forEach((task, index) => {
            const div = document.createElement('div');
            div.className = 'subtask-item';
            div.innerHTML = `
                <span>${task}</span>
                <i class="fa-solid fa-times subtask-remove" onclick="removeSubtask(${index})"></i>
            `;
            list.appendChild(div);
        });

        // Toggle Done button
        const btnDone = document.getElementById('btnDone');
        if (currentSubtasks.length > 0) {
            btnDone.disabled = false;
            btnDone.style.opacity = '1';
            btnDone.style.cursor = 'pointer';
        } else {
            btnDone.disabled = true;
            btnDone.style.opacity = '0.5';
            btnDone.style.cursor = 'not-allowed';
        }
    }

    function submitTask() {
        if (currentSubtasks.length === 0) return;

        const category = document.getElementById('taskTitle').value; // Title acts as Category
        const priority = document.getElementById('taskPriority').value;
        const dueDate = document.getElementById('taskDueDate').value;
        const isGroup = document.getElementById('modal-is-group').value === '1';

        const payload = {
            category: category,
            priority: priority,
            due_date: dueDate,
            is_group: isGroup,
            subtasks: currentSubtasks
        };

        fetch('/todos/add_batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeAddTaskModal();
                    window.location.reload();
                } else {
                    alert('Error creating tasks');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred');
            });
    }

    window.onclick = function (event) {
        const modal = document.getElementById('addTaskModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}